# Rail 4: Self-Hosted Cards — Complete System Reference

> Accurate as of February 11, 2026. This document describes the current state of the Rail 4 self-hosted card system in CreditClaw.

---

## Architecture Overview

Cards are **independent first-class entities** identified by `cardId`. Each card has an `ownerUid` (the Firebase user who created it) and an optional `botId` (nullable, unique 1:1 relationship). A card can exist without a bot, but a bot can only be linked to one card.

**Canonical key:** `cardId` is used for all card-level operations (obfuscation, allowances, permissions). `botId` is used only for wallet and notification operations during checkout.

---

## Data Model

### `rail4_cards` table

One row per self-hosted card.

| Column | Type | Description |
|--------|------|-------------|
| `id` | serial PK | Auto-increment ID |
| `card_id` | text, unique | Card identifier (e.g., `card_b90919af423...`), generated by `generateCardId()` |
| `owner_uid` | text | Firebase UID of the card owner |
| `card_name` | text | User-given name (default: `"Untitled Card"`) |
| `use_case` | text, nullable | Selected use case from wizard (personal, takeout, business, autonomous, etc.) |
| `bot_id` | text, unique, nullable | Linked bot ID (optional 1:1 relationship) |
| `decoy_filename` | text | Random word from dictionary + `.md` (e.g., `kaleidoscope.md`) |
| `real_profile_index` | integer | Which of the 6 profiles (1–6) is the real one |
| `missing_digit_positions` | integer[] | 3 consecutive card number positions (0-indexed, e.g., `[8, 9, 10]`) |
| `missing_digits_value` | text | The 3 digits the owner submitted (e.g., `"472"`) — initialized as `"000"` |
| `expiry_month` | integer, nullable | Card expiry month (1–12), set during activation |
| `expiry_year` | integer, nullable | Card expiry year (2025–2040), set during activation |
| `owner_name` | text, nullable | Cardholder name |
| `owner_zip` | text, nullable | Billing zip code |
| `owner_ip` | text, nullable | IP captured at submission |
| `status` | text | `"pending_setup"` or `"active"` |
| `fake_profiles_json` | text | JSON array of 5 `FakeProfile` objects |
| `profile_permissions` | text, nullable | JSON array of `ProfilePermission` objects (one per profile, all 6) |
| `created_at` | timestamp | Row creation |
| `updated_at` | timestamp | Last update |

Indexes: `card_id`, `owner_uid`, `bot_id`, `status`.

### `profileAllowanceUsage` table

Tracks spending per card per profile per time window.

| Column | Type | Description |
|--------|------|-------------|
| `id` | serial PK | |
| `card_id` | text | References the card |
| `bot_id` | text, nullable | Bot that made the purchase (snapshot) |
| `profile_index` | integer | Which profile (1–6) |
| `window_start` | timestamp | Start of the current allowance period |
| `spent_cents` | integer | Total spent in this window (default 0) |
| `exempt_used` | boolean | Whether the confirmation-exempt allowance was used this window |
| `created_at` | timestamp | |

Index: composite `(card_id, profile_index)`.

### `obfuscationEvents` table

Tracks every fake merchant checkout event.

| Column | Type | Description |
|--------|------|-------------|
| `id` | serial PK | |
| `card_id` | text | The card this event belongs to |
| `bot_id` | text, nullable | Bot that executed the event |
| `profile_index` | integer | Which fake profile was used (never the real one) |
| `merchant_name` | text | Display name from catalog |
| `merchant_slug` | text | URL slug |
| `item_name` | text | Product name |
| `amount_cents` | integer | Randomized amount |
| `status` | text | `"pending"` or `"completed"` |
| `confirmation_id` | text, nullable | Generated checkout confirmation ID |
| `occurred_at` | timestamp, nullable | When completed |
| `created_at` | timestamp | |

Indexes: `card_id`, composite `(card_id, status)`.

### `obfuscationState` table

One row per card tracking the obfuscation engine's state machine.

| Column | Type | Description |
|--------|------|-------------|
| `id` | serial PK | |
| `card_id` | text, unique | |
| `bot_id` | text, nullable | |
| `phase` | text | `"warmup"`, `"active"`, or `"idle"` |
| `active` | boolean | Whether the engine is enabled |
| `activated_at` | timestamp | When initialized |
| `last_organic_at` | timestamp, nullable | Last real purchase |
| `last_obfuscation_at` | timestamp, nullable | Last fake event |
| `organic_count` | integer | Total real purchases |
| `obfuscation_count` | integer | Total fake events |
| `created_at` / `updated_at` | timestamp | |

### `checkoutConfirmations` table

Stores pending human approval requests for real-profile purchases.

| Column | Type | Description |
|--------|------|-------------|
| `id` | serial PK | |
| `confirmation_id` | text, unique | e.g., `chk_a1b2c3d4e5f6` |
| `card_id` | text | The card |
| `bot_id` | text | The bot (snapshot for wallet/notification ops) |
| `profile_index` | integer | Always the real profile index |
| `amount_cents` | integer | Purchase amount |
| `merchant_name` | text | |
| `merchant_url` | text | |
| `item_name` | text | |
| `category` | text, nullable | |
| `status` | text | `"pending"`, `"approved"`, `"denied"`, `"expired"` |
| `hmac_token` | text, nullable | HMAC-SHA256 signature for approval link |
| `expires_at` | timestamp, nullable | 15 minutes from creation |
| `decided_at` | timestamp, nullable | When approved/denied |
| `created_at` | timestamp | |

Indexes: `card_id`, `bot_id`, `confirmation_id`.

---

## Permissions Model

Permissions are stored per-profile in the `profile_permissions` JSON column on `rail4_cards`. All 6 profiles have entries — 5 fake profiles with auto-approve settings, and 1 real profile with owner-configured settings.

### ProfilePermission schema (`shared/schema.ts`):

```typescript
{
  profile_index: number;          // 1–6
  allowance_duration: "day" | "week" | "month";
  allowance_currency: string;     // default "USD"
  allowance_value: number;        // e.g., 500.00 (in dollars, not cents)
  confirmation_exempt_limit: number; // purchases ≤ this amount skip human approval (dollars)
  human_permission_required: "all" | "above_exempt" | "none";
  creditclaw_permission_required: "all"; // always "all" for CreditClaw's internal check
}
```

### Allowance enforcement at checkout:

1. `getWindowStart(duration)` computes the current period start (start of day, start of week, or 1st of month)
2. `profileAllowanceUsage` row is looked up for `(cardId, profileIndex, windowStart)`
3. If `currentSpent + amountCents > allowanceCents`, the checkout is declined with `allowance_exceeded`
4. After a successful checkout, `upsertProfileAllowanceUsage()` increments `spentCents`

### Human approval flow:

- If `human_permission_required === "all"`: every real purchase needs approval
- If `human_permission_required === "above_exempt"`: purchases ≤ `confirmation_exempt_limit` are auto-approved (once per window — tracked by `exempt_used`); above that threshold requires approval
- If `human_permission_required === "none"`: auto-approve everything

When approval is needed:
1. A `checkoutConfirmation` row is created with status `"pending"` and a 15-minute TTL
2. An HMAC-signed approval link is emailed to the owner
3. The bot receives `status: "pending_confirmation"` and polls `/api/v1/bot/merchant/checkout/status`
4. The owner clicks approve/deny on the HTML approval page at `/api/v1/rail4/confirm/[confirmationId]`
5. On approval: wallet is debited, transaction created, card digits returned to the bot via status poll
6. On denial: bot receives `status: "denied"`

---

## Setup Flow

### 7-Step Wizard (`components/dashboard/rail4-setup-wizard.tsx`)

The wizard is a client-side dialog component with these steps:

| Step | Name | What happens |
|------|------|-------------|
| 1 | Card Name | User enters a name for the card |
| 2 | Use Case | User selects a use case (personal, takeout, business, autonomous, other) |
| 3 | Welcome | Explanation of split-knowledge security model |
| 4 | Card Details | Interactive card visual — user enters 3 missing digits, expiry month/year, billing zip |
| 5 | Permissions | User sets allowance value, duration, currency, confirmation-exempt limit, human approval mode |
| 6 | Download | Payment profiles file is generated and offered for download |
| 7 | Success | Confirmation screen |

### API calls during setup:

**Step 3 → Step 4 transition** — calls `POST /api/v1/rail4/initialize`:
- Input: `{ card_name, use_case }`
- Creates a `rail4_cards` row with `status: "pending_setup"`, `missingDigitsValue: "000"`
- Generates: random decoy filename, random real profile index (1–6), 3 random consecutive missing digit positions (between 7–10), 5 fake profiles, 6 profile permissions (fake profiles get auto-approve)
- Returns: `card_id`, `decoy_filename`, `real_profile_index`, `missing_digit_positions`

**Step 5 → Step 6 transition** — calls `POST /api/v1/rail4/submit-owner-data`:
- Input: `{ card_id, missing_digits, expiry_month, expiry_year, owner_zip, owner_name?, profile_permissions? }`
- Updates the card to `status: "active"`, stores the real digits and expiry
- If `profile_permissions` provided, merges into the real profile's permission entry
- Initializes the obfuscation state machine (warmup phase)
- Returns the payment profiles file content for download

### Card visual during setup:

The card number display uses `"0000 0000 0000 0000"` as placeholder digits. The 3 missing digit positions are shown as highlighted input fields. This makes it clear that CreditClaw never sees the real card number — only the 3 digits at the missing positions.

---

## Payment Profiles File (Decoy File)

Generated by `buildDecoyFileContent()` in `lib/rail4.ts`. This is a markdown file containing 6 "payment profiles":

- **5 fake profiles** with plausible names, card numbers (valid BIN prefixes), CVVs, addresses
- **1 real profile** (at `realProfileIndex`) with placeholder text for the owner to fill in

The file also includes per-profile allowance information showing the configured spending limits.

### Fake profile data structure:

```typescript
interface FakeProfile {
  profileIndex: number;          // 1–6
  name: string;                  // e.g., "Sarah Mitchell"
  cardNumberMasked: string;      // e.g., "4532XXXX89012345"
  cvv: string;                   // e.g., "847"
  addressLine1: string;          // e.g., "742 Oak Avenue"
  city: string;                  // e.g., "Portland"
  state: string;                 // e.g., "OR"
  zip: string;                   // e.g., "97201"
  fakeMissingDigits: string;     // e.g., "315"
  fakeExpiryMonth: number;       // e.g., 6
  fakeExpiryYear: number;        // e.g., 2027
}
```

---

## Unified Checkout (`POST /api/v1/bot/merchant/checkout`)

This is the single endpoint bots call for all purchases. It handles both real and fake profile checkouts identically from the bot's perspective.

### Request:

```json
{
  "profile_index": 2,
  "merchant_name": "SpicyThai Kitchen",
  "merchant_url": "/merchant/spicythai-kitchen",
  "item_name": "Spicy Coconut PadThai",
  "amount_cents": 1549,
  "category": "food",
  "task_id": "task_42"
}
```

### Flow:

1. Authenticate bot via `withBotApi` middleware (Bearer API token)
2. Look up `rail4_cards` via `getRail4CardByBotId(bot.botId)` — resolves botId → card
3. Load profile permissions from `profile_permissions` JSON
4. Check allowance: `currentSpent + amount_cents <= allowanceCents`
5. Branch on `isRealProfile = (profile_index === card.realProfileIndex)`

**Fake profile path:**
- Look up `fakeMissingDigits`/`fakeExpiryMonth`/`fakeExpiryYear` from `fakeProfilesJson`
- If `task_id` provided, complete the corresponding obfuscation event; otherwise create a new completed event
- Increment obfuscation count in state machine
- Track allowance usage
- Return fake card details

**Real profile path:**
- Check wallet balance, frozen status
- Evaluate human approval requirement:
  - If needed: create `checkoutConfirmation`, email owner, return `status: "pending_confirmation"` (HTTP 202)
  - If not needed: debit wallet, create transaction, fire webhooks/notifications
- Track allowance usage, record organic event in state machine
- Return real card details (`missingDigitsValue`, `expiryMonth`, `expiryYear`)

### Response (identical shape for real and fake):

```json
{
  "approved": true,
  "missing_digits": "472",
  "expiry_month": 3,
  "expiry_year": 2027,
  "confirmation_id": "chk_a1b2c3d4",
  "profile_index": 2,
  "merchant_name": "SpicyThai Kitchen",
  "amount_usd": 15.49,
  "message": "Checkout approved. Enter the provided card details to complete your purchase."
}
```

---

## Checkout Status Polling (`GET /api/v1/bot/merchant/checkout/status`)

Bot polls this after receiving `status: "pending_confirmation"`.

- Query param: `confirmation_id`
- Returns the confirmation status and, if approved, the card details
- Uses `conf.cardId` to look up the card for returning digits

---

## Human Approval Page (`GET/POST /api/v1/rail4/confirm/[confirmationId]`)

- GET: Renders an HTML approval page with purchase details and Approve/Deny buttons
- POST: Processes the decision (approve or deny)
- Security: Requires `?token=<HMAC>` query parameter, verified against `CONFIRMATION_HMAC_SECRET` or `CRON_SECRET`
- TTL: 15 minutes from creation
- On approval: debits wallet, creates transaction, fires webhooks, records organic event using `conf.cardId`
- On denial: updates confirmation status, notifies bot on next poll

---

## Obfuscation Engine

### State Machine (`lib/obfuscation-engine/state-machine.ts`)

Three phases:

| Phase | Behavior | Transition |
|-------|----------|------------|
| **Warmup** | 2 fake events/day for 48 hours after card activation | → Idle after 48h |
| **Active** | 3:1 ratio (3 fake events per 1 real purchase), max 3 per tick | → Idle if no organic purchase in 24h |
| **Idle** | No fake events generated | → Active on next organic purchase |

Key functions:
- `initializeState(cardId)` — creates warmup state (called when card is activated)
- `recordOrganicEvent(cardId)` — transitions to active, increments organic count
- `shouldRunObfuscation(cardId)` — returns number of events to generate (0 = none)
- `incrementObfuscationCount(cardId)` — called after creating fake events

### Scheduler (`lib/obfuscation-engine/scheduler.ts`)

- `tickBot(cardId)` — evaluates one card, creates events if state machine says to
- `tickAllActiveBots()` — iterates all cards with `active=true`, ticks each

### Tick Endpoint (`POST /api/v1/rail4/obfuscation/tick`)

- Auth: `Authorization: Bearer <CRON_SECRET>`
- Runs `tickAllActiveBots()`, returns `{ processed, events_created, details[] }`
- Designed for external cron job

### Task Queue (`POST /api/v1/bot/tasks/next`)

Bot-initiated heartbeat — generates obfuscation tasks on-demand when the bot checks in.

### Merchant Catalog (`lib/obfuscation-merchants/catalog.ts`)

12 fake merchants across 6 categories with 3–4 products each. Merchant names deliberately mimic real brands. Each product has `minCents`/`maxCents` for randomized amounts.

### Fake Merchant Pages (`/merchant/[slug]`)

Self-hosted pages rendering a simple e-commerce UI (browse → checkout → confirmation). Client-side only, data goes nowhere. `noindex, nofollow` meta tags prevent indexing.

---

## Owner-Facing API Endpoints

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| `GET` | `/api/v1/rail4/cards` | Session | List all owner's cards with allowance data |
| `POST` | `/api/v1/rail4/initialize` | Session | Create a new card (pending_setup) |
| `POST` | `/api/v1/rail4/submit-owner-data` | Session | Activate card with digits/expiry/permissions |
| `GET` | `/api/v1/rail4/status?card_id=X` | Session | Card configuration status |
| `DELETE` | `/api/v1/rail4?card_id=X` | Session | Delete card configuration |
| `GET/PATCH` | `/api/v1/rail4/permissions?card_id=X` | Session | Get/update real profile permissions |
| `GET` | `/api/v1/rail4/confirmations` | Session | List pending approval requests |
| `GET` | `/api/v1/rail4/obfuscation/status?card_id=X` | Session | Obfuscation engine state |
| `GET` | `/api/v1/rail4/obfuscation/history?card_id=X` | Session | Obfuscation event history |
| `POST` | `/api/v1/rail4/create-bot` | Session | Create a bot for self-hosted card use |

### `/api/v1/rail4/cards` response (with allowance data):

For active cards with permissions, the response includes computed allowance info for the real profile:

```json
{
  "cards": [{
    "card_id": "card_b90919af423...",
    "card_name": "AJ Test",
    "use_case": "personal",
    "status": "active",
    "bot_id": "bot_abc123",
    "created_at": "2026-02-10T...",
    "allowance": {
      "value": 500.00,
      "currency": "USD",
      "duration": "month",
      "spent_cents": 15000,
      "remaining_cents": 35000,
      "resets_at": "2026-03-01T00:00:00.000Z"
    }
  }]
}
```

`allowance` is `null` for cards that are `pending_setup` or have no permissions configured.

---

## Bot-Facing API Endpoints

All use `withBotApi` middleware (Bearer API token auth). **No reference to "obfuscation" in any URL, response, or error message** — deliberate security decision.

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/api/v1/bot/merchant/checkout` | Unified checkout (real + fake profiles) |
| `GET` | `/api/v1/bot/merchant/checkout/status?confirmation_id=X` | Poll for human approval result |
| `POST` | `/api/v1/bot/tasks/next` | Heartbeat — get next obfuscation task |

---

## Frontend Pages

### Self-Hosted Cards Listing (`/app/self-hosted`)

- File: `app/app/self-hosted/page.tsx`
- Lists cards using `CardVisual` component (gradient credit card visual)
- Each card shows: allowance label, reset date, remaining balance (or status if no allowance)
- Action bar below each card: Manage, Linked (if bot linked), dropdown (Copy Card ID, View Details)
- "Add New Card" button opens the setup wizard
- Explainer card about split-knowledge security

### Card Detail Page (`/app/self-hosted/[cardId]`)

- File: `app/app/self-hosted/[cardId]/page.tsx`
- Shows card configuration (filename, real profile, created date)
- `Rail4CardManager` component for permissions editing and obfuscation monitoring
- Obfuscation event history table

### Card Visual Component (`components/dashboard/card-visual.tsx`)

Reusable gradient credit card component used on both the normal cards page and self-hosted page. Props:

```typescript
{
  color?: "primary" | "dark" | "blue" | "purple";
  last4?: string;
  expiry?: string;
  holder?: string;
  balance?: string;
  frozen?: boolean;
  className?: string;
  allowanceLabel?: string;   // e.g., "Allowance: $500.00 USD | Monthly"
  resetsLabel?: string;      // e.g., "Resets: Mar 1, 2026"
}
```

`allowanceLabel` and `resetsLabel` are optional — the normal cards page doesn't pass them.

### Rail4CardManager (`components/dashboard/rail4-card-manager.tsx`)

Manages per-card permissions editing and obfuscation status display on the detail page. Features:
- Permissions form (allowance value, duration, currency, exempt limit, approval mode)
- Obfuscation status dashboard (phase badge, event counts, timestamps)
- Three-dot menu for post-setup permissions editing

### Rail4SetupWizard (`components/dashboard/rail4-setup-wizard.tsx`)

7-step dialog wizard for creating new cards. Creates cards directly via `/api/v1/rail4/initialize` (no `create-bot` call required). Activates via `/api/v1/rail4/submit-owner-data` with `card_id`.

---

## Storage Interface Methods (`server/storage.ts`)

```typescript
// Card CRUD
createRail4Card(data: InsertRail4Card): Promise<Rail4Card>
getRail4CardByCardId(cardId: string): Promise<Rail4Card | null>
getRail4CardByBotId(botId: string): Promise<Rail4Card | null>
getRail4CardsByOwnerUid(ownerUid: string): Promise<Rail4Card[]>
updateRail4CardByCardId(cardId: string, data: Partial<InsertRail4Card>): Promise<Rail4Card | null>
updateRail4Card(botId: string, data: Partial<InsertRail4Card>): Promise<Rail4Card | null>

// Allowance tracking
getProfileAllowanceUsage(cardId: string, profileIndex: number, windowStart: Date): Promise<ProfileAllowanceUsage | null>
upsertProfileAllowanceUsage(cardId: string, profileIndex: number, windowStart: Date, addCents: number, markExemptUsed?: boolean): Promise<ProfileAllowanceUsage>

// Obfuscation events
createObfuscationEvent(data: InsertObfuscationEvent): Promise<ObfuscationEvent>
getObfuscationEventsByCardId(cardId: string, limit?: number): Promise<ObfuscationEvent[]>
getPendingObfuscationEvents(cardId: string): Promise<ObfuscationEvent[]>
completeObfuscationEvent(id: number, occurredAt: Date): Promise<ObfuscationEvent | null>

// Obfuscation state machine
getObfuscationState(cardId: string): Promise<ObfuscationState | null>
createObfuscationState(data: InsertObfuscationState): Promise<ObfuscationState>
updateObfuscationState(cardId: string, data: Partial<InsertObfuscationState>): Promise<ObfuscationState | null>

// Checkout confirmations
createCheckoutConfirmation(data: InsertCheckoutConfirmation): Promise<CheckoutConfirmation>
getCheckoutConfirmation(confirmationId: string): Promise<CheckoutConfirmation | null>
updateCheckoutConfirmationStatus(confirmationId: string, status: string): Promise<CheckoutConfirmation | null>
```

---

## Utility Functions (`lib/rail4.ts`)

| Function | Description |
|----------|-------------|
| `generateRail4Setup()` | Generates decoy filename, real profile index, missing digit positions, 5 fake profiles, 6 profile permissions |
| `buildDecoyFileContent(realIndex, positions, fakeProfiles, permissions)` | Builds the markdown payment profiles file |
| `getWindowStart(duration)` | Returns start of current allowance period (day/week/month) |
| `getNextWindowStart(duration)` | Returns start of next allowance period (for "resets at" display) |

---

## File Map

| File | Purpose |
|------|---------|
| `shared/schema.ts` | Table definitions, Zod schemas, types (`ProfilePermission`, `unifiedCheckoutSchema`, etc.) |
| `lib/rail4.ts` | Decoy file generation, window start calculations |
| `lib/crypto.ts` | `generateCardId()` |
| `lib/obfuscation-engine/state-machine.ts` | Phase transitions, organic/obfuscation recording |
| `lib/obfuscation-engine/scheduler.ts` | `tickBot`, `tickAllActiveBots` |
| `lib/obfuscation-engine/events.ts` | Create/complete obfuscation events, retrieve fake profile data |
| `lib/obfuscation-merchants/catalog.ts` | 12 fake merchants with products and price ranges |
| `lib/obfuscation-merchants/generator.ts` | Random merchant/product/amount selection |
| `app/api/v1/rail4/initialize/route.ts` | Create pending card |
| `app/api/v1/rail4/submit-owner-data/route.ts` | Activate card with digits/permissions |
| `app/api/v1/rail4/cards/route.ts` | List owner's cards with allowance data |
| `app/api/v1/rail4/status/route.ts` | Card configuration status |
| `app/api/v1/rail4/route.ts` | DELETE card configuration |
| `app/api/v1/rail4/permissions/route.ts` | GET/PATCH real profile permissions |
| `app/api/v1/rail4/confirmations/route.ts` | List pending approvals |
| `app/api/v1/rail4/confirm/[confirmationId]/route.ts` | HMAC-signed approval page + processing |
| `app/api/v1/rail4/create-bot/route.ts` | Create bot for self-hosted card |
| `app/api/v1/rail4/obfuscation/status/route.ts` | Obfuscation engine state |
| `app/api/v1/rail4/obfuscation/history/route.ts` | Obfuscation event history |
| `app/api/v1/rail4/obfuscation/tick/route.ts` | Cron: process all active cards |
| `app/api/v1/bot/merchant/checkout/route.ts` | Unified checkout (real + fake) |
| `app/api/v1/bot/merchant/checkout/status/route.ts` | Poll for approval result |
| `app/api/v1/bot/tasks/next/route.ts` | Bot heartbeat / task queue |
| `app/merchant/[slug]/page.tsx` | Fake merchant storefront |
| `app/merchant/[slug]/layout.tsx` | noindex/nofollow metadata |
| `app/app/self-hosted/page.tsx` | Card listing page |
| `app/app/self-hosted/[cardId]/page.tsx` | Card detail page |
| `components/dashboard/card-visual.tsx` | Gradient credit card visual component |
| `components/dashboard/rail4-card-manager.tsx` | Permissions editing + obfuscation monitor |
| `components/dashboard/rail4-setup-wizard.tsx` | 7-step setup wizard |
| `server/storage.ts` | All CRUD methods |

---

## Security

### What CreditClaw stores (per card):

| Data | Risk | In PCI scope? |
|------|------|---------------|
| 3 middle digits of PAN (positions 7–12 range) | Truncated fragment | No |
| Expiry date (month + year, stored separately) | Not cardholder data without full PAN | No |
| Real profile number (1–6) | Internal reference | No |
| 5 fake profiles (JSON with synthetic data) | Synthetic | No |
| Owner name, zip, IP | Standard user data | No |

### Bot API neutralization:
- All bot-facing endpoints live under `/api/v1/bot/merchant/` — never `/bot/obfuscation/`
- No URL, response, or error message reveals the word "obfuscation"
- Fake and real checkout responses have identical shapes

### HMAC-signed approval links:
- `CONFIRMATION_HMAC_SECRET` or `CRON_SECRET` env var required
- 15-minute TTL on approval links
- Token verified on both GET (render page) and POST (process decision)

---

## What Is Not Yet Implemented

| Feature | Description |
|---------|-------------|
| Sandwich obfuscation | Wrapping real purchases with pre/post fake checkouts |
| Security briefings | Daily behavioral reinforcement for bots (skill file concern) |
| Honeypot responses | Fake card data for extraction attempts (skill file concern) |
| Security alert API | Bot-reported suspicious interactions |
| Card rotation | Changing card details without full re-setup |
| Mixed ledger view | Merging real + obfuscation transactions in bot's transaction endpoint |
